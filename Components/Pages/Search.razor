@page "/search"
@inject RecipeService Service

<h1 class="title">search</h1>

<div class="searchbar">
	<input @bind="text" @bind:event="oninput" placeholder="find" />
</div>

@if (list.Count == 0)
{
	<div class="card searchempty">
		<p>empty</p>
		<a class="button primary" href="/add">add</a>
	</div>
}
else
{
	<div class="searchgrid">
		@foreach (var item in list)
		{
			<button class="card tile" @onclick="() => Open(item)">
				<p class="tilename">@item.Name</p>
				<p class="tilemeta">@string.Join(", ", item.Ingredients.Take(4))</p>
			</button>
		}
	</div>
}

@if (pick is not null)
{
	<div class="mask" @onclick="Close"></div>
	<section class="modal" role="dialog" aria-modal="true">
		<div class="modalhead">
			<p>@(edit ? "edit" : pick.Name)</p>
			<button class="icon" aria-label="close" @onclick="Close">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
					<line x1="18" y1="6" x2="6" y2="18" />
					<line x1="6" y1="6" x2="18" y2="18" />
				</svg>
			</button>
		</div>

		<div class="modalbody">
			@if (!edit)
			{
				<p class="key">ingredients</p>
				<p class="copy">@string.Join(", ", pick.Ingredients)</p>
				<p class="key">steps</p>
				<p class="copy">@pick.Instructions</p>
			}
			else
			{
				<label class="field">
					<span>name</span>
					<input @bind="name" />
				</label>
				<label class="field">
					<span>ingredients</span>
					<input @bind="items" />
				</label>
				<label class="field">
					<span>steps</span>
					<textarea @bind="steps" rows="4"></textarea>
				</label>
			}
		</div>

		<div class="modalfoot">
			@if (!edit)
			{
				@if (drop)
				{
					<button class="button danger" @onclick="Kill">confirm</button>
					<button class="button" @onclick="Undo">cancel</button>
				}
				else
				{
					<button class="button danger" @onclick="Ask">delete</button>
					<button class="button primary" @onclick="Start">edit</button>
				}
			}
			else
			{
				<button class="button" @onclick="Stop">cancel</button>
				<button class="button primary" @onclick="Save">save</button>
			}
		</div>
	</section>
}

@code {
	private string text = "";
	private Recipe? pick;
	private bool edit;
	private bool drop;
	private string name = "";
	private string items = "";
	private string steps = "";

	private List<Recipe> list => Service.GetAll().Where(Match).ToList();

	private bool Match(Recipe item)
	{
		if (string.IsNullOrWhiteSpace(text))
		{
			return true;
		}

		return item.Name.Contains(text, StringComparison.OrdinalIgnoreCase) || item.Ingredients.Any(x => x.Contains(text, StringComparison.OrdinalIgnoreCase));
	}

	private void Open(Recipe item)
	{
		pick = item;
		edit = false;
		drop = false;
	}

	private void Close()
	{
		pick = null;
		edit = false;
		drop = false;
	}

	private void Start()
	{
		if (pick is null)
		{
			return;
		}

		name = pick.Name;
		items = string.Join(", ", pick.Ingredients);
		steps = pick.Instructions;
		edit = true;
		drop = false;
	}

	private void Stop()
	{
		edit = false;
		drop = false;
	}

	private void Save()
	{
		if (pick is null || string.IsNullOrWhiteSpace(name))
		{
			return;
		}

		var list = items.Split(',').Select(x => x.Trim()).Where(x => x.Length > 0).ToList();
		var item = new Recipe(name.Trim(), list, steps.Trim());
		Service.UpdateRecipe(pick, item);
		pick = item;
		edit = false;
		drop = false;
	}

	private void Ask()
	{
		drop = true;
	}

	private void Undo()
	{
		drop = false;
	}

	private void Kill()
	{
		if (pick is null)
		{
			return;
		}

		Service.DeleteRecipe(pick);
		Close();
	}
}
